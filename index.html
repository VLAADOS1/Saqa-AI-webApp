<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Photo Mini‚ÄëApp</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --violet-dark:#140019;
    --violet:#43135c;
    --violet-light:#5d2b7b;
    --txt:#fff;
    --radius:14px;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,'Segoe UI',Roboto,sans-serif}
  body{
    min-height:100vh;color:var(--txt);
    background:
      radial-gradient(circle at 20% 10%,rgba(255,255,255,.06) 0 8%,transparent 10%) repeat,
      radial-gradient(circle at 80% 80%,rgba(255,255,255,.04) 0 6%,transparent 8%) repeat,
      linear-gradient(145deg,var(--violet) 0%,var(--violet-dark) 100%);
    background-size:120px 120px,160px 160px,100% 100%;
    display:flex;align-items:center;justify-content:center;
    padding:3vh 3vw;
  }

  .hidden{display:none!important}

  .grid{
    display:grid;
    gap:10px;
    width:100%;
    max-width:380px;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  }
  .span-2{grid-column:span 2}

  button{
    background:var(--violet);
    border:2px solid rgba(255,255,255,.07);
    border-radius:var(--radius);
    color:var(--txt);
    font-size:18px;
    font-weight:600;
    padding:14px 12px;
    text-align:left;
    display:flex;
    align-items:center;
    gap:8px;
    cursor:pointer;
    transition:background .25s,transform .15s;
    width:100%;
  }
  button:active{transform:scale(.97)}
  button:hover{background:var(--violet-light)}
  .icon{font-size:1.4em;flex:0 0 auto}
  @media(max-width:380px){button{font-size:16px}}

  #btnHelp,#btnEnhance,#btnResize,#btnErase{justify-content:center;text-align:center}

  .info-wrap{
    max-width:380px;width:100%;
    background:rgba(0,0,0,.35);
    border:2px solid rgba(255,255,255,.1);
    border-radius:var(--radius);
    padding:16px 18px;
    line-height:1.36;
    font-size:16px;
  }
  .info-wrap h3{margin:0 0 8px;font-size:17px}
  .info-wrap p{margin:10px 0}

  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ modal + draw ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:30;background:#0008}
  .modal.active{display:flex}
  .modal-box{background:var(--violet-dark);border:2px solid rgba(255,255,255,.15);border-radius:var(--radius);padding:16px;max-width:90vw;max-height:85vh;overflow:auto;position:relative;text-align:center}
  .modal-box img{max-width:100%;border-radius:var(--radius);display:block;margin:0 auto 12px}
  .close{font-size:28px;cursor:pointer;position:absolute;top:10px;right:16px;user-select:none}
  .instructions{margin-bottom:12px;font-size:16px;line-height:1.35}
  .draw-box{position:relative;display:inline-block}
  .draw-box img{display:block;max-width:100%;height:auto;border-radius:var(--radius)}
  .draw-box canvas{position:absolute;inset:0;width:100%;height:100%;border-radius:var(--radius);touch-action:none}
  .tool-toggle{position:absolute;bottom:8px;right:8px;padding:6px 8px;background:#0009;border:0;border-radius:50%;backdrop-filter:blur(4px);cursor:pointer;color:#fff;font-size:18px;line-height:1}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ì–õ–ê–í–ù–ê–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<section id="page-main">
  <div class="grid">
    <!-- 1‚Äë–π —Ä—è–¥ -->
    <button id="btnPhoto"><span class="icon">üì∑</span> –°–æ–∑–¥–∞—Ç—å —Ñ–æ—Ç–æ</button>
    <button id="btnVideo"><span class="icon">üé¨</span> –°–æ–∑–¥–∞—Ç—å –≤–∏–¥–µ–æ</button>

    <!-- 2‚Äë–π —Ä—è–¥ -->
    <button id="btnEnhance"><span class="icon">‚ú®</span> –£–ª—É—á—à–∏—Ç—å —Ñ–æ—Ç–æ</button>
    <button id="btnResize"><span class="icon">üìê</span> –£–≤–µ–ª–∏—á–∏—Ç—å —Ñ–æ—Ç–æ</button>

    <!-- 3‚Äë–π —Ä—è–¥ -->
    <button id="btnErase" class="span-2"><span class="icon">üßΩ</span> –£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç</button>

    <!-- 4‚Äë–π —Ä—è–¥ -->
    <button id="btnAgent"><span class="icon">üß¨</span> –°–æ–∑–¥–∞—Ç—å –∞–≥–µ–Ω—Ç–∞</button>
    <button id="btnClothes"><span class="icon">üëï</span> –°–º–µ–Ω–∏—Ç—å –æ–¥–µ–∂–¥—É</button>

    <!-- 5‚Äë–π —Ä—è–¥ -->
    <button id="btnSwitchAgent"><span class="icon">üîÑ</span> –°–º–µ–Ω–∏—Ç—å –∞–≥–µ–Ω—Ç–∞</button>
    <button id="btnFilters"><span class="icon">üé®</span> –ù–∞—à–∏ —Ñ–∏–ª—å—Ç—Ä—ã</button>

    <!-- 6‚Äë–π —Ä—è–¥ -->
    <button id="btnBalance"><span class="icon">üîç</span> –ú–æ–π –±–∞–ª–∞–Ω—Å</button>
    <button id="btnBuy"><span class="icon">üí∞</span> –ö—É–ø–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</button>

    <!-- 7‚Äë–π —Ä—è–¥ -->
    <button id="btnHelp" class="span-2"><span class="icon">‚ÑπÔ∏è</span> –ü–æ–º–æ—â—å</button>
  </div>
</section>

<!-- –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ (filters, resize, info, help) –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ –ú–æ–¥–∞–ª–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="modal" id="eraseModal">
  <div class="modal-box">
    <span class="close" id="eraseClose">&times;</span>
    <div id="eraseContent">
      <img id="eraseImg" src="" alt="">
      <button class="btn" id="eraseChoose">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</button>
    </div>
  </div>
</div>

<div class="modal" id="drawModal">
  <div class="modal-box">
    <div id="drawContent"></div>
  </div>
</div>

<input type="file" accept="image/*" id="eraseInput" hidden>

<!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ JS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script>
if (window.Telegram?.WebApp){
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
}

const $     = s => document.querySelector(s);
const show  = el => el.classList.remove('hidden');
const hide  = el => el.classList.add('hidden');

/* —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
const pageMain    = $('#page-main');
const pageFilters = $('#page-filters');
const pageResize  = $('#page-resize');
const pageInfo    = $('#page-info');
const pageHelp    = $('#page-help');

/* –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞ */
function send(action, payload = {}){
  const data = JSON.stringify({ action, ...payload });
  Telegram.WebApp?.sendData(data);
}

/* –∫–Ω–æ–ø–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é */
$('#btnPhoto').onclick   = () => { hide(pageMain); show(pageFilters); };
$('#btnVideo').onclick   = () => send('create_video');
$('#btnAgent').onclick   = () => send('create_agent');
$('#btnClothes').onclick = () => location.href='main.html';
$('#btnSwitchAgent').onclick=() => send('change_agent');
$('#btnFilters').onclick = () => { hide(pageMain); show(pageInfo); };
$('#btnBalance').onclick = () => send('balance');
$('#btnBuy').onclick     = () => send('buy_generations');
$('#btnEnhance').onclick = () => send('enhance_photo');
$('#btnResize').onclick  = () => { hide(pageMain); show(pageResize); };
$('#btnHelp').onclick    = () => { hide(pageMain); show(pageHelp); };

/* –≤–æ–∑–≤—Ä–∞—Ç */
$('#back-filters')?.addEventListener('click',()=>{ show(pageMain); hide(pageFilters); });
$('#back-resize') ?.addEventListener('click',()=>{ show(pageMain); hide(pageResize); });
$('#back-info')   ?.addEventListener('click',()=>{ show(pageMain); hide(pageInfo); });
$('#back-help')   ?.addEventListener('click',()=>{ show(pageMain); hide(pageHelp); });

/* –≤—ã–±–æ—Ä —Ñ–∏–ª—å—Ç—Ä–∞ */
pageFilters?.querySelectorAll('button[data-filter]').forEach(btn=>{
  btn.onclick=()=>{
    send('generate_photo',{filter:btn.dataset.filter});
    show(pageMain); hide(pageFilters);
  };
});

/* –≤—ã–±–æ—Ä —Ä–∞–∑–º–µ—Ä–∞ */
pageResize?.querySelectorAll('button[data-size]').forEach(btn=>{
  btn.onclick=()=>{
    send('resize_photo',{size:btn.dataset.size});
    show(pageMain); hide(pageResize);
  };
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ delete object flow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const eraseBtn    = $('#btnErase'),
      eraseModal  = $('#eraseModal'),
      eraseClose  = $('#eraseClose'),
      eraseImg    = $('#eraseImg'),
      eraseChoose = $('#eraseChoose'),
      eraseInput  = $('#eraseInput'),
      drawModal   = $('#drawModal'),
      drawContent = $('#drawContent');

let userPhotoFile=null;

/* upload helper */
async function uploadFile(fileOrBlob,name){
  const eps=[
    {url:'https://tmpfiles.org/api/v1/upload',field:'file', pick:r=>r?.data?.url||r?.url},
    {url:'https://uguu.se/upload',            field:'files[]',pick:r=>Array.isArray(r)?r[0]?.url:r?.url}
  ];
  for(const ep of eps){
    try{
      const fd=new FormData(); fd.append(ep.field,fileOrBlob,name);
      const res=await fetch(ep.url,{method:'POST',body:fd});
      const data=JSON.parse(await res.text());
      const link=ep.pick(data); if(link) return link.trim();
    }catch{}
  }
  throw new Error('upload failed');
}

/* open choose photo */
eraseBtn.onclick=()=>{eraseImg.src=''; eraseModal.classList.add('active');};
eraseClose.onclick=()=>eraseModal.classList.remove('active');
eraseModal.addEventListener('click',e=>{
  if(e.target===eraseModal) eraseModal.classList.remove('active');
});
eraseChoose.onclick=()=>eraseInput.click();

/* photo selected */
eraseInput.onchange=e=>{
  const file=e.target.files[0]; if(!file) return;
  userPhotoFile=file;
  const fr=new FileReader();
  fr.onload=ev=>{
    eraseModal.classList.remove('active');
    startDrawMode(ev.target.result);
  };
  fr.readAsDataURL(file);
};

/* draw mode */
function startDrawMode(src){
  drawContent.innerHTML='';
  drawModal.classList.add('active');

  drawContent.insertAdjacentHTML('beforeend',
    '<div class="instructions">–û–±–≤–µ–¥–∏ –æ–±—ä–µ–∫—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (üßΩ¬†/¬†üñçÔ∏è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å¬†–ª–∞—Å—Ç–∏–∫).</div>');

  const box=document.createElement('div'); box.className='draw-box';
  const img=document.createElement('img'); img.src=src;
  const cv =document.createElement('canvas');
  box.append(img,cv); drawContent.append(box);

  const toggle=document.createElement('button'); toggle.className='tool-toggle'; toggle.textContent='üßΩ';
  box.append(toggle);
  let eraser=false; toggle.onclick=()=>{eraser=!eraser; toggle.textContent=eraser?'üñçÔ∏è':'üßΩ';};

  const done=document.createElement('button'); done.className='btn'; done.textContent='–ì–æ—Ç–æ–≤–æ';
  done.style.marginTop='16px'; drawContent.append(done);

  img.onload=()=>{
    cv.width = img.clientWidth;
    cv.height= img.clientHeight;
    const ctx=cv.getContext('2d');

    initDrawing(cv,ctx,()=>eraser);
  };

  done.onclick=async()=>{
    drawContent.innerHTML='<div class="instructions">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º‚Ä¶</div>';
    try{
      const maskDataUrl=makeMask(cv,img.naturalWidth,img.naturalHeight);
      const photoURL   =await uploadFile(userPhotoFile,'photo_'+Date.now()+'.png');
      const maskBlob   =await (await fetch(maskDataUrl)).blob();
      const maskURL    =await uploadFile(maskBlob,'mask_'+Date.now()+'.png');
      send('erase_object',{photo:photoURL,mask:maskURL});
      drawContent.innerHTML='<div class="instructions">‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É!</div>';
    }catch{
      drawContent.innerHTML='<div class="instructions" style="color:#f55">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
    }
  };
}

/* drawing */
function initDrawing(cv,ctx,isEraser){
  const COLOR='rgba(128,0,255,0.5)', WIDTH=40;
  ctx.lineWidth=WIDTH; ctx.lineCap='round'; ctx.lineJoin='round';
  let drawing=false,prev=null;
  const pos=e=>{
    const r=cv.getBoundingClientRect();
    const p=e.touches?e.touches[0]:e;
    return{x:(p.clientX-r.left),y:(p.clientY-r.top)};
  };
  const start=e=>{e.preventDefault(); drawing=true; prev=pos(e);};
  const move =e=>{
    if(!drawing) return;
    e.preventDefault();
    const curr=pos(e);
    if(isEraser()){
      ctx.save(); ctx.globalCompositeOperation='destination-out';
      ctx.beginPath(); ctx.moveTo(prev.x,prev.y); ctx.lineTo(curr.x,curr.y); ctx.stroke(); ctx.restore();
    }else{
      ctx.save(); ctx.globalCompositeOperation='destination-out';
      ctx.beginPath(); ctx.moveTo(prev.x,prev.y); ctx.lineTo(curr.x,curr.y); ctx.stroke(); ctx.restore();

      ctx.save(); ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=COLOR;
      ctx.beginPath(); ctx.moveTo(prev.x,prev.y); ctx.lineTo(curr.x,curr.y); ctx.stroke(); ctx.restore();
    }
    prev=curr;
  };
  const stop=()=>{drawing=false; prev=null;};
  cv.addEventListener('mousedown',start);
  cv.addEventListener('mousemove',move);
  window.addEventListener('mouseup',stop);
  cv.addEventListener('touchstart',start,{passive:false});
  cv.addEventListener('touchmove',move,{passive:false});
  window.addEventListener('touchend',stop);
}

/* mask generator */
function makeMask(srcCanvas,nw,nh){
  const m=document.createElement('canvas'); m.width=nw; m.height=nh;
  const mx=m.getContext('2d');
  mx.drawImage(srcCanvas,0,0,nw,nh);
  const id=mx.getImageData(0,0,nw,nh); const d=id.data;
  for(let i=0;i<d.length;i+=4){
    const on=d[i+3]>0, val=on?255:0;
    d[i]=d[i+1]=d[i+2]=val; d[i+3]=255;
  }
  mx.putImageData(id,0,0);
  return m.toDataURL('image/png');
}

/* close draw modal click outside */
drawModal.addEventListener('click',e=>{
  if(e.target===drawModal) drawModal.classList.remove('active');
});
</script>
</body>
</html>
